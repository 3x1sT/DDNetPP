version: 2
defaults: &defaults
  working_directory: ~/DDNetPP/DDNetPP
  docker:
    - image: buildpack-deps:stretch

defignore: &defignore
  filters:
    branches:
      ignore:
        - /.*\.tmp/

jobs:
  build:
    <<: *defaults
    parallelism: 1

    steps:
      - checkout
      - run: |
          apt-get update
          apt-get install -y build-essential \
            cmake \
            python3 \
            libcurl4-openssl-dev
      # Compile
      - run:
        -name: build bam debug
        -command: |
          ./bam server_debug
          ./DDNetPP_d shutdown
      - run:
        -name: build bam release
        -command: |
          ./bam server_release
          ./DDNetPP shutdown
      - run:
        -name: build cmake
        -command: |
          mkdir -p build
          cd build
          cmake ..
          make
          ./DDNetPP
      - persist-to-workspace:
          root: ./
          paths: ./*

workflows:
    version: 2
    build_and_test:
        jobs:
            - build:
                <<: *defignore
